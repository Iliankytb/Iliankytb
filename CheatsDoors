local player = game.Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- Fonction pour créer des éléments UI
local function createUIElement(className, parent, properties)
    local element = Instance.new(className)
    element.Parent = parent
    for prop, value in pairs(properties) do
        element[prop] = value
    end
    return element
end

-- Supprimer l'ancien GUI si présent
local oldGui = player.PlayerGui:FindFirstChild("GuiPlayer")
if oldGui then
    oldGui:Destroy()
end

-- Création du GUI
local screenGui = createUIElement("ScreenGui", player.PlayerGui, { Name = "GuiPlayer", ResetOnSpawn = false })

-- Main Frame
local frame = createUIElement("Frame", screenGui, {
    Size = UDim2.new(0.25, 0, 0.75, 0),
    Position = UDim2.new(0.7, -90, 0.2, 0),
    BackgroundColor3 = Color3.fromRGB(60, 60, 60),
    BackgroundTransparency = 0.25,
    Visible = false
})

-- Fonction pour afficher un message de bienvenue quand le GUI est ouvert
local welcomeText = createUIElement("TextLabel", screenGui, {
    Size = UDim2.new(0.5, 0, 0.1, 0),
    Position = UDim2.new(0.25, 0, 0.05, 0),
    Text = "Thanks To Support Me!",
    TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = Enum.Font.GothamBold,
    TextSize = 24,
    BackgroundTransparency = 1,
    Visible = false
})

-- Gradient sur le Frame
createUIElement("UIGradient", frame, {
    Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(60, 60, 60)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(90, 90, 90))
    }
})

-- UI Stroke et Coin arrondi pour le Frame
createUIElement("UIStroke", frame, {
    Thickness = 3,
    Color = Color3.fromRGB(20, 20, 20),
    LineJoinMode = Enum.LineJoinMode.Round
})

createUIElement("UICorner", frame, { CornerRadius = UDim.new(0.1, 0) })

-- Bouton pour afficher/masquer le GUI
local toggleButton = createUIElement("TextButton", screenGui, {
    Size = UDim2.new(0, 100, 0, 25),
    Position = UDim2.new(0.9, -60, 0.2, 0),
    Text = "Toggle Menu",
    TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = Enum.Font.GothamBold,
    TextSize = 18,
    BackgroundColor3 = Color3.fromRGB(85, 170, 255)
})

-- Sidebar Frame à gauche
local sidebarFrame = createUIElement("Frame", screenGui, {
    Size = UDim2.new(0.2, 0, 0.75, 0),
    Position = UDim2.new(0.5, -90, 0.2, 0),
    BackgroundColor3 = Color3.fromRGB(40, 40, 40),
    BackgroundTransparency = 0.25,
    Visible = false
})

-- Scrolling Frame dans sidebar
local sidebarScrollingFrame = createUIElement("ScrollingFrame", sidebarFrame, {
    Size = UDim2.new(1, 0, 1, 0),
    CanvasSize = UDim2.new(0, 0, 0, 800),
    ScrollBarThickness = 8,
    BackgroundTransparency = 1
})

-- Frame des boutons ESP
local scrollingframeEsp = createUIElement("ScrollingFrame", frame, {
    Size = UDim2.new(1, 0, 1, 0),
    CanvasSize = UDim2.new(0, 0, 0, 800),
    ScrollBarThickness = 8,
    BackgroundTransparency = 1,
    Visible = false
})

-- Main Scrolling Frame
local scrollingFrame = createUIElement("ScrollingFrame", frame, {
    Size = UDim2.new(1, 0, 1, 0),
    CanvasSize = UDim2.new(0, 0, 0, 800),
    ScrollBarThickness = 8,
    BackgroundTransparency = 1
})

-- Fonction pour créer des boutons avec changement de texte "On/Off"
local function createButton(text, parent, callback)
    local button = createUIElement("TextButton", parent, {
        Size = UDim2.new(0.90, 0, 0, 50),
        Text = text,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Font = Enum.Font.GothamBold,
        TextSize = 16,
        BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    })

    -- Gradient sur chaque bouton
    createUIElement("UIGradient", button, {
        Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 70, 70)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(100, 100, 100))
        }
    })

    createUIElement("UIStroke", button, {
        Thickness = 2,
        Color = Color3.fromRGB(20, 20, 20),
        LineJoinMode = Enum.LineJoinMode.Round
    })

    createUIElement("UICorner", button, { CornerRadius = UDim.new(0.1, 0) })

    -- Connecter le callback pour le bouton
    button.MouseButton1Click:Connect(callback)

    return button
end

-- Fonction pour afficher/masquer différentes sections (Main, ESP, Player, etc.)
local function showSection(sectionFrame)
    scrollingFrame.Visible = false
    scrollingframeEsp.Visible = false
    sectionFrame.Visible = true
end

-- UIListLayout pour organiser les boutons dans le frame principal et le scrolling ESP
createUIElement("UIListLayout", sidebarScrollingFrame, {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 10)
})

createUIElement("UIListLayout", scrollingFrame, {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 10)
})

createUIElement("UIListLayout", scrollingframeEsp, {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 10)
})

-- Boutons dans la sidebar
createButton("Main", sidebarScrollingFrame, function()
    showSection(scrollingFrame)
end)

createButton("ESP", sidebarScrollingFrame, function()
    showSection(scrollingframeEsp)
end)

createButton("Player", sidebarScrollingFrame, function()
    -- TODO: Ajouter fonctionnalité pour la section Player
end)

createButton("Give Item", sidebarScrollingFrame, function()
    -- TODO: Ajouter fonctionnalité pour la section Give Item
end)

createButton("Information", sidebarScrollingFrame, function()
    -- TODO: Ajouter fonctionnalité pour la section Information
end)

local removeGuiButton = createButton("Remove UI", sidebarScrollingFrame, function()
    if screenGui then
        screenGui:Destroy()
    end
end)

-- Fonctionnalité ESP
local espActive = false
local espTargets = {}
local FullBrightActive = false

local function toggleFullBright()
    FullBrightActive = not FullBrightActive
    game.Lighting.Brightness = FullBrightActive and 100 or 1
end

welcomeText.Visible = true
wait(5)  -- Affiche le message pendant 2 secondes
welcomeText.Visible = false

local function highlightPlayers()
    espTargets = {}
    for _, player in pairs(game.Players:GetPlayers()) do
        local char = player.Character
        local humanoidRootPart = char and char:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            -- Ajouter Highlight aux personnages des joueurs
            highlightModel(char)
            table.insert(espTargets, char)
        end
    end
end

-- Ajout des nouveaux boutons dans scrollingFrame (Main)
local fullBrightButton = createButton("Full Bright", scrollingFrame, function()
    toggleFullBright()
    fullBrightButton.Text = "Full Bright On" or "Full Bright Off"
end)

local noLagButton = createButton("No Lag", scrollingFrame, function()
    if next(originalMaterials) == nil then
        activateNoLag()
        noLagButton.Text = "No Lag On"
    else
        restoreMaterials()
        noLagButton.Text = "No Lag Off"
    end
end)

-- Fonctionnalité ESP pour voir les joueurs
local espPlayerButton = createButton("Esp Player", scrollingframeEsp, function()
    if espActive then
        disableESP()
        espPlayerButton.Text = "ESP Off"
    else
        highlightPlayers()
        espActive = true
        espPlayerButton.Text = "ESP On"
    end
end)

-- Bouton pour désactiver le ESP
local espOffButton = createButton("ESP Off", scrollingFrame, function()
    if espActive then
        disableESP()
        espPlayerButton.Text = "ESP Off"
    else
        espPlayerButton.Text = "ESP Off"
    end
end)

-- Fonction pour désactiver ESP
local function disableESP()
    for _, target in pairs(espTargets) do
        local highlight = target:FindFirstChildOfClass("Highlight")
        if highlight then
            highlight:Destroy()
        end
    end
    espTargets = {}
    espActive = false
end

-- Activation/Désactivation du ESP sur les joueurs
espPlayerButton.MouseButton1Click:Connect(function()
    if espActive then
        disableESP()
        espPlayerButton.Text = "ESP Off"
    else
        highlightPlayers()
        espActive = true
        espPlayerButton.Text = "ESP On"
    end
end)

-- Fonction pour bloquer/débloquer la souris selon l'état du GUI
local function updateMouseState()
    if frame.Visible then
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    else
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
    end
end

-- Gestion de la surbrillance automatique sur les joueurs
RunService.Heartbeat:Connect(function()
    if espActive then
        for _, char in pairs(espTargets) do
            if not char:FindFirstChildOfClass("Highlight") then
                highlightModel(char)
            end
        end
    end
end)

-- Fonction pour afficher/masquer le GUI avec la touche "Q"
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Q then
        frame.Visible = not frame.Visible
        sidebarFrame.Visible = not sidebarFrame.Visible
        updateMouseState()  -- Met à jour l'état de la souris en fonction de la visibilité du GUI
    end
end)

-- Fonction pour afficher/masquer le GUI via le bouton "Toggle Menu"
toggleButton.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
    sidebarFrame.Visible = not sidebarFrame.Visible
    updateMouseState()
end)

-- Centrer le GUI sur le joueur
local function centerGuiOnPlayer()
    frame.Position = UDim2.new(0.5, -frame.Size.X.Offset/2, 0.75, -frame.Size.Y.Offset/2)
    sidebarFrame.Position = UDim2.new(0.3, -sidebarFrame.Size.X.Offset/2, 0.75, -sidebarFrame.Size.Y.Offset/2)
end

-- Recentre les frames lorsque le GUI est affiché
frame:GetPropertyChangedSignal("Visible"):Connect(function()
    if frame.Visible then
        centerGuiOnPlayer()
    end
end)

-- Fonction pour surbrillance des objets
local function highlightModel(model)
    if not model:FindFirstChildOfClass("Highlight") then
        local highlight = createUIElement("Highlight", model, {
            FillColor = Color3.fromRGB(255, 0, 0),
            OutlineColor = Color3.fromRGB(255, 255, 255),
            FillTransparency = 0.5,
            OutlineTransparency = 0
        })
    end
end

-- Gestion des boutons ESP Off et On
espOffButton.MouseButton1Click:Connect(function()
    if espActive then
        disableESP()
        espOffButton.Text = "ESP Off"
    else
        espOffButton.Text = "ESP Off"
    end
end)

